import java.nio.file.Path
import java.time.LocalDateTime
import java.time.format.DateTimeFormatter

gradle.allprojects {
    ext.getCurrentVersion = { ->
        def stdout = new ByteArrayOutputStream()
        String tagIsh
        try {
            exec {
                commandLine 'git', 'describe', '--tags', '--exclude="[dD]ev*"'
                standardOutput = stdout
            }
            tagIsh = stdout.toString().trim().toLowerCase()
        } catch(Exception e) {
            tagIsh = "dev-Unknown"
        }
        // Dev tags: v2021.1.6-3-gf922466d
        // We're specifically looking to capture the middle -3-
        boolean isDev = tagIsh.matches(".*-[0-9]*-g[0-9a-f]*")
        if(isDev && !tagIsh.startsWith("dev-")) tagIsh = "dev-" + tagIsh
        println("Picked up version: " + tagIsh)
        return tagIsh
    }

    if(!ext.has("versionString")) {
        ext.versionString = getCurrentVersion()
    }

    ext.writePhotonVersionFile = { Path path, String version ->
        println("Writing " + version + " to " + path.toAbsolutePath().toString())
        String date = DateTimeFormatter.ofPattern("yyyy-M-d hh:mm:ss").format(LocalDateTime.now())
        File versionFile = new File(path.toAbsolutePath().toString())
        versionFile.delete()
        versionFile << "package org.photonvision;\n" +
                "\n" +
                "/*\n" +
                " * Autogenerated file! Do not manually edit this file. This version is regenerated\n" +
                " * any time the publish task is run, or when this file is deleted.\n" +
                " */\n" +
                "\n" +
                "@SuppressWarnings(\"ALL\")\n" +
                "public final class PhotonVersion {\n" +
                "    public static final String versionString = \"${version}\";\n" +
                "    public static final String buildDate = \"${date}\";\n" +
                "    public static final boolean isRelease = !versionString.startsWith(\"dev\");\n" +
                "}"
    }
}
