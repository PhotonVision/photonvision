# Cross-Platform Build Strategy for photon-apple

## Problem Summary
- `photon-core` contains `AppleModel.java` and `AppleObjectDetector.java` that reference Swift-generated bindings
- These bindings only exist when photon-apple builds (macOS only)
- Linux/Windows builds fail because they can't compile classes referencing missing photon-apple artifacts

### Current Usage
photon-apple is currently used in only 2 files in photon-core:
1. **NeuralNetworkModelManager.java** (line 360): `new AppleModel(properties)` - instantiates AppleModel when loading APPLE family models
2. **RequestHandler.java** (line 682): `new AppleModel(modelProperties).load()` - creates detector when switching to APPLE model

### Runtime Safety Already Exists
The code already has proper runtime guards:
- `NeuralNetworkModelManager` only adds `Family.APPLE` to `supportedBackends` on macOS (via `Platform.getCurrentPlatform() == MACOS`)
- This means `AppleModel`/`AppleObjectDetector` are **never instantiated** on non-macOS platforms at runtime
- The problem is **compile-time only** - Java compiler can't compile classes with missing dependencies

### Key Dependencies to Handle
Both classes import from photon-apple module:
1. **Swift-generated bindings**: `com.photonvision.apple.ObjectDetector` (generated by JExtract from Swift code)
2. **Swift-generated loader**: `com.photonvision.apple.AppleVisionLibraryLoader` (generated)
3. **SwiftKit FFM API**: `org.swift.swiftkit.ffm.AllocatingSwiftArena` (from swift-java submodule)

## Proposed Solutions

### Option 1: Stub Implementations
Use Gradle source sets to conditionally compile different versions based on build platform.

**Structure:**
```
photon-core/
├── src/main/java/                           # Real implementations (macOS only)
│   └── org/photonvision/vision/objects/
│       ├── AppleModel.java                  # Real - calls photon-apple
│       └── AppleObjectDetector.java         # Real - uses Swift bindings
├── src/stub/java/                           # Stub implementations (Linux/Windows)
│   └── org/photonvision/vision/objects/
│       ├── AppleModel.java                  # Stub - throws UnsupportedOperationException
│       └── AppleObjectDetector.java         # Stub - throws UnsupportedOperationException
```

**Gradle Configuration:**
```gradle
sourceSets {
    if (System.getProperty("os.name").toLowerCase().contains("mac")) {
        main {
            java {
                srcDirs = ['src/main/java']  // Use real implementations
            }
        }
    } else {
        main {
            java {
                srcDirs = ['src/stub/java']  // Use stubs instead
            }
        }
    }
}
```

**Stub Implementation Details:**
- Stubs implement the same public API but throw `UnsupportedOperationException` in all methods
- No imports from photon-apple or SwiftKit - completely self-contained
- Safe because runtime guards ensure stubs are never called on non-macOS platforms

**Pros:**
- ✅ Minimal changes - just add stub files and update Gradle
- ✅ Works immediately on all platforms
- ✅ No refactoring of existing code needed
- ✅ Type-safe - compiler validates API compatibility
- ✅ Clear separation - easy to see platform-specific vs stub code

**Cons:**
- ⚠️ Code duplication (two versions of each class)
- ⚠️ Must keep stub signatures in sync with real implementations

---

### Option 2: Move to photon-apple Module
Move `AppleModel.java` and `AppleObjectDetector.java` from photon-core → photon-apple module.

**Changes Required:**
1. Move classes to `photon-apple/src/main/java/org/photonvision/vision/objects/`
2. Update `NeuralNetworkModelManager` to use reflection or dynamic loading:
   ```java
   case APPLE -> {
       try {
           Class<?> appleModelClass = Class.forName("org.photonvision.vision.objects.AppleModel");
           Constructor<?> ctor = appleModelClass.getConstructor(ModelProperties.class);
           Model model = (Model) ctor.newInstance(properties);
           models.get(properties.family()).add(model);
       } catch (ClassNotFoundException e) {
           logger.error("AppleModel not available on this platform");
       }
   }
   ```
3. Update `RequestHandler` similarly
4. Ensure photon-core declares `Model` interface (already exists)

**Pros:**
- ✅ Cleaner separation of concerns - Apple code stays in photon-apple
- ✅ No stub files needed
- ✅ photon-core has zero Apple-specific code

**Cons:**
- ⚠️ More invasive - requires refactoring model loading logic
- ⚠️ Loses compile-time type safety (uses reflection)
- ⚠️ May affect future expansion if more places need to reference Apple detectors
- ⚠️ Runtime complexity (reflection, error handling)

---

### Option 3: Pre-built JAR Artifacts
Build photon-apple on macOS, publish to Maven, and depend on pre-built JAR on all platforms.

**Changes Required:**
1. CI/CD workflow to build photon-apple on macOS runner
2. Publish photon-apple JAR to Maven (GitHub Packages or local repo)
3. All platforms depend on pre-built photon-apple:
   ```gradle
   implementation "org.photonvision:photon-apple:${version}"  // Always included
   ```
4. Keep existing runtime guards to prevent instantiation on non-macOS

**Pros:**
- ✅ No code changes needed
- ✅ Works on all platforms (compiled .class files are portable)
- ✅ Swift bindings are pre-generated

**Cons:**
- ⚠️ Requires CI/CD infrastructure
- ⚠️ Version management complexity
- ⚠️ Local development requires manual artifact publishing
- ⚠️ Still ships macOS-only code to all platforms (wasted space)

---

## Recommendation

**BETTER APPROACH: Stub within photon-apple module itself**

Instead of stubbing individual files in photon-core (which doesn't scale), stub the entire photon-apple module:

### Why This is Better:
1. **Scales infinitely**: photon-core can use Apple classes anywhere (DeviceMetrics.java, etc.) without worrying about platform compatibility
2. **Single source of truth**: Stubs live in photon-apple where they belong
3. **No refactoring needed**: AppleModel/AppleObjectDetector stay in photon-core
4. **Future-proof**: Any future use of Swift code "just works"

### Implementation Steps

#### 1. Create stub directory structure in photon-apple:

```bash
mkdir -p photon-apple/src/stub/java/com/photonvision/apple
```

#### 2. Create stub implementations for all photon-apple classes:

**Hand-written classes to stub:**
- `ImageUtils.java` - Simple utilities (no dependencies)
- `AppleVisionLibraryLoader.java` - Stub: `initialize()` is no-op, `isInitialized()` returns false
- `NativeLibraryLoader.java` - Stub: `loadLibrary()` throws `UnsupportedOperationException`
- `SwiftArena.java` - Trampoline wrapper for SwiftKit's AllocatingSwiftArena (see step 5 for details)

**Swift-generated classes to stub:**
- `ObjectDetector.java` - Stub all methods to throw `UnsupportedOperationException`
- `DetectionResult.java` - Stub data class
- `DetectionResultArray.java` - Stub array wrapper
- `AppleVisionLibrary.java` - Stub library interface

**Key requirement:** Stubs must NOT import SwiftKit classes (`org.swift.swiftkit.*`). They should be completely self-contained.

#### 3. Update `photon-apple/build.gradle`:

Replace the entire file with platform-conditional logic:

```gradle
plugins {
    id 'java-library'
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(24)
    }
}

def isMacOS = System.getProperty("os.name").toLowerCase().contains("mac")

if (isMacOS) {
    // macOS: Build Swift library and use real implementations
    sourceSets {
        main {
            java {
                srcDirs = ['src/main/java', '.build/plugins/outputs/photon-apple/AppleVisionLibrary/destination/JExtractSwiftPlugin/src/generated/java']
            }
        }
    }

    dependencies {
        testImplementation 'org.junit.jupiter:junit-jupiter:5.11.4'

        // SwiftKit dependencies (only on macOS)
        api 'org.swift.swiftkit:swiftkit-core:1.0-SNAPSHOT'
        api 'org.swift.swiftkit:swiftkit-ffm:1.0-SNAPSHOT'
    }

    // Task to clean cached dylibs
    task cleanCachedDylibs(type: Exec) {
        commandLine 'sh', '-c', 'rm -rf ../photon-server/photonvision_config/nativelibs/*.dylib 2>/dev/null || true'
        workingDir projectDir
        doLast {
            println "Cleaned cached dylibs"
        }
    }

    // Task to build Swift library
    task buildSwift(type: Exec) {
        dependsOn cleanCachedDylibs
        commandLine 'swift', 'build', '-c', 'release'
        workingDir projectDir
    }

    // Package dylibs into JAR
    processResources {
        dependsOn buildSwift
        def buildDir = "${projectDir}/.build/release"
        from(buildDir) {
            include '*.dylib'
            into 'native/macos'
        }
    }

    tasks.compileJava.dependsOn(buildSwift)

    test {
        useJUnitPlatform()
        enabled = project.hasProperty('runAppleTests')
    }

} else {
    // Linux/Windows: Use stub implementations, skip Swift build
    sourceSets {
        main {
            java {
                srcDirs = ['src/stub/java']  // Use stubs instead
            }
        }
    }

    dependencies {
        testImplementation 'org.junit.jupiter:junit-jupiter:5.11.4'
        // No SwiftKit dependencies on non-macOS
    }

    test {
        useJUnitPlatform()
        enabled = false  // Can't run tests without real implementation
    }
}

repositories {
    mavenCentral()
    mavenLocal()
}
```

#### 4. Update `photon-core/build.gradle`:

Remove the platform check for photon-apple dependency - it's now always available:

```gradle
// Before (conditional dependency):
if (System.getProperty("os.name").toLowerCase().contains("mac")) {
    implementation project(':photon-apple')
}

// After (always available):
implementation project(':photon-apple')  // Works on all platforms via stubs
```

Also remove this:
```gradle
// Before (conditional build dependency):
if (System.getProperty("os.name").toLowerCase().contains("mac")) {
    compileJava.dependsOn ':photon-apple:compileJava'
}

// After (not needed - Gradle handles this automatically):
// (remove this block entirely)
```

#### 5. Create SwiftKit trampoline wrapper in photon-apple:

The real `AppleObjectDetector` in photon-core currently imports `org.swift.swiftkit.ffm.AllocatingSwiftArena`. We need to avoid this direct import by trampolining through photon-apple.

**Create `photon-apple/src/main/java/com/photonvision/apple/SwiftArena.java`:**
```java
package com.photonvision.apple;

import org.swift.swiftkit.ffm.AllocatingSwiftArena;

/**
 * Wrapper around SwiftKit's AllocatingSwiftArena to avoid direct SwiftKit imports in photon-core.
 * This allows photon-core to use Swift arenas without depending on SwiftKit directly.
 */
public class SwiftArena {
    private final AllocatingSwiftArena arena;

    private SwiftArena(AllocatingSwiftArena arena) {
        this.arena = arena;
    }

    /**
     * Create an automatic arena that is cleaned up by the garbage collector.
     */
    public static SwiftArena ofAuto() {
        return new SwiftArena(AllocatingSwiftArena.ofAuto());
    }

    /**
     * Create a confined arena that must be explicitly closed.
     */
    public static SwiftArena ofConfined() {
        return new SwiftArena(AllocatingSwiftArena.ofConfined());
    }

    /**
     * Get the underlying AllocatingSwiftArena for use with Swift bindings.
     */
    public AllocatingSwiftArena unwrap() {
        return arena;
    }

    /**
     * Close this arena (only for confined arenas).
     */
    public void close() {
        // AllocatingSwiftArena doesn't have a close method for auto arenas
        // This is a no-op for ofAuto() arenas
    }
}
```

**Create stub `photon-apple/src/stub/java/com/photonvision/apple/SwiftArena.java`:**
```java
package com.photonvision.apple;

/**
 * Stub implementation of SwiftArena for non-macOS platforms.
 */
public class SwiftArena {
    private SwiftArena() {}

    public static SwiftArena ofAuto() {
        throw new UnsupportedOperationException(
            "Apple object detection is only supported on macOS");
    }

    public static SwiftArena ofConfined() {
        throw new UnsupportedOperationException(
            "Apple object detection is only supported on macOS");
    }

    public Object unwrap() {
        throw new UnsupportedOperationException(
            "Apple object detection is only supported on macOS");
    }

    public void close() {
        // No-op stub
    }
}
```

**Update `AppleObjectDetector` in photon-core** to use the trampoline:
- Replace `import org.swift.swiftkit.ffm.AllocatingSwiftArena` with `import com.photonvision.apple.SwiftArena`
- Change all `AllocatingSwiftArena` references to `SwiftArena`
- Use `arena.unwrap()` when passing to Swift bindings
- Move `AppleVisionLibraryLoader.initialize()` call into the AppleObjectDetector constructor

#### 6. Test the build:

```bash
# On Linux/Windows:
./gradlew clean build -x test -x spotlessCheck
# Should succeed - photon-apple builds with stubs

# On macOS:
./gradlew clean build -x test -x spotlessCheck
# Should succeed - photon-apple builds with real Swift code
```

---

## Stub Implementation Example

Here's what a stub would look like:

**photon-apple/src/stub/java/com/photonvision/apple/ObjectDetector.java:**
```java
package com.photonvision.apple;

// No imports from SwiftKit - completely self-contained

public class ObjectDetector {
    public static ObjectDetector init(String modelPath, Object arena) {
        throw new UnsupportedOperationException(
            "Apple object detection is only supported on macOS");
    }

    public DetectionResultArray detect(Object mem, int width, int height,
                                       double threshold, Object arena) {
        throw new UnsupportedOperationException(
            "Apple object detection is only supported on macOS");
    }
}
```

---

---

## Final Recommendation

**Stub photon-apple module with SwiftKit trampoline:**

1. **Stub photon-apple itself** (as described above) - this is the key change
2. **Keep AppleModel and AppleObjectDetector in photon-core** - no changes needed to photon-core structure
3. **Use SwiftArena trampoline** to avoid direct SwiftKit imports in photon-core
4. **Move initialization** - `AppleVisionLibraryLoader.initialize()` moves into AppleObjectDetector constructor

This approach:
- ✅ Scales infinitely - use Swift/Apple code anywhere in photon-core (DeviceMetrics.java, etc.)
- ✅ No source sets needed in photon-core - AppleModel/AppleObjectDetector stay as-is
- ✅ No direct SwiftKit imports in photon-core - trampolined through SwiftArena wrapper
- ✅ Single source of truth - all stubs live in photon-apple where they belong
- ✅ Clean builds on all platforms without refactoring

### Summary of Changes

**photon-apple:**
- Add `src/stub/java/` with stub implementations
- Add `SwiftArena.java` trampoline wrapper (both real and stub versions)
- Update `build.gradle` with platform-conditional source sets

**photon-core:**
- Update `AppleObjectDetector.java`:
  - Replace `import org.swift.swiftkit.ffm.AllocatingSwiftArena` → `import com.photonvision.apple.SwiftArena`
  - Change all `AllocatingSwiftArena` → `SwiftArena`
  - Use `arena.unwrap()` when passing to Swift bindings
  - Add `AppleVisionLibraryLoader.initialize()` to constructor
- Update `AppleModel.java`:
  - Remove `AppleVisionLibraryLoader.initialize()` call (now in AppleObjectDetector constructor)
- Update `build.gradle`:
  - Remove platform check: always `implementation project(':photon-apple')`
  - Remove conditional `compileJava.dependsOn`

**photon-core/build.gradle changes:**
```gradle
// OLD - conditional dependency:
if (System.getProperty("os.name").toLowerCase().contains("mac")) {
    implementation project(':photon-apple')
}

// NEW - always available:
implementation project(':photon-apple')
```

```gradle
// OLD - conditional build dependency:
if (System.getProperty("os.name").toLowerCase().contains("mac")) {
    compileJava.dependsOn ':photon-apple:compileJava'
}

// NEW - remove this block entirely (Gradle handles dependency order automatically)
```
